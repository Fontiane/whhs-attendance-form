<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hills Football Attendance Form</title>
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Open+Sans&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #121212;
      color: #C0C0C0;
      padding: 20px;
      background-image: url('https://images.unsplash.com/photo-1603808033192-082d6919a144?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80');
      background-size: cover;
      background-attachment: fixed;
    }
    .logo-container { text-align: center; margin-bottom: 20px; }
    .logo-container img { width: 150px; height: auto; }
    h1 {
      text-align: center; font-family: 'Anton', sans-serif; font-size: 3em;
      color: #C0C0C0; text-shadow: 2px 2px #006400;
    }
    label { font-weight: bold; display: block; margin: 20px 0 10px; font-size: 18px; color: #C0C0C0; }
    input[type="date"] { font-size: 16px; padding: 5px; border-radius: 5px; border: 1px solid #999; }
    .group {
      background-color: rgba(0, 100, 0, 0.85);
      padding: 15px; margin: 20px 0; border-radius: 8px;
      box-shadow: 0 0 15px rgba(192, 192, 192, 0.4);
    }
    .group h2 { color: #fff; margin-top: 0; }
    button {
      display: block; margin: 30px auto; padding: 12px 24px; font-size: 18px;
      background-color: #006400; color: #C0C0C0; border: none; border-radius: 8px; cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover { background-color: #004d00; }
    .status { max-width: 900px; margin: 10px auto; text-align: center; }
    .status.error { color: #ffb3b3; }
    .status.info { color: #c0ffc0; }
  </style>
</head>
<body>

  <div class="logo-container">
    <img src="https://fontiane.github.io/whhs-attendance-form/Hills_White.jpeg" alt="Hills Logo" />
  </div>

  <h1>WHHS Football Attendance</h1>

  <div id="status" class="status info" aria-live="polite">Loading roster…</div>

  <label for="attendanceDate">Date:</label>
  <input type="date" id="attendanceDate" name="date" required />

  <!-- Dynamic Player Groups from Google Sheet -->
  <div id="playerGroupsContainer"></div>

  <form
    id="attendanceForm"
    method="POST"
    onsubmit="return prepareForm()"
    action="https://script.google.com/macros/s/AKfycbydtp_ibUwYI6xFGQxe5AgI47CGfvpm8NssT-yfr7TCGVkDmw7CX0DtvC0fzg6guHXDow/exec"
  >
    <input type="hidden" name="data" id="attendanceData" />
    <input type="hidden" name="date" id="formattedDate" />
    <button type="submit">Submit Attendance</button>
  </form>

  <script>
    // Use the latest Web App deployment URL here:
    const SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbydtp_ibUwYI6xFGQxe5AgI47CGfvpm8NssT-yfr7TCGVkDmw7CX0DtvC0fzg6guHXDow/exec";

    const statusEl = document.getElementById("status");

    function setTodayDate() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      document.getElementById("attendanceDate").value = `${yyyy}-${mm}-${dd}`;
    }

    async function loadRoster() {
      // Simple GET, explicit CORS mode, cache-bust query
      const url = `${SCRIPT_URL}?t=${Date.now()}`;

      const resp = await fetch(url, {
        method: "GET",
        mode: "cors",       // allow cross-origin (server must send ACAO header)
        cache: "no-cache",  // avoid cached 302/old cached JSON
        credentials: "omit" // do not send cookies
      });

      if (!resp.ok) {
        // If Apps Script returns an error JSON, try to show it
        let msg = `HTTP ${resp.status}`;
        try { const j = await resp.json(); if (j && j.message) msg += ` — ${j.message}`; } catch {}
        throw new Error(msg);
      }
      return resp.json();
    }

    function renderRoster(data) {
      const container = document.getElementById("playerGroupsContainer");
      container.innerHTML = "";

      ["Seniors", "Juniors", "Sophomores", "Freshmen"].forEach((playerClass) => {
        if (!data[playerClass] || !data[playerClass].length) return;

        const groupDiv = document.createElement("div");
        groupDiv.className = "group";

        const header = document.createElement("h2");
        header.textContent = playerClass;
        groupDiv.appendChild(header);

        data[playerClass].forEach((name) => {
          const label = document.createElement("label");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.dataset.name = name;
          checkbox.dataset.class = playerClass;

          // label text
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(" " + name));

          groupDiv.appendChild(label);
          groupDiv.appendChild(document.createElement("br"));
        });

        container.appendChild(groupDiv);
      });
    }

    function prepareForm() {
      const allPlayers = {};
      document.querySelectorAll('input[type="checkbox"]').forEach((box) => {
        const cls = box.dataset.class;
        if (!allPlayers[cls]) allPlayers[cls] = [];
        allPlayers[cls].push({ name: box.dataset.name, present: box.checked });
      });

      document.getElementById("attendanceData").value = JSON.stringify(allPlayers);
      document.getElementById("formattedDate").value = document.getElementById("attendanceDate").value;
      return true; // allow form submit
    }

    window.onload = async function () {
      setTodayDate();
      try {
        const data = await loadRoster();        // GET (CORS)
        renderRoster(data);
        statusEl.textContent = "Roster loaded.";
        statusEl.className = "status info";
      } catch (err) {
        console.error("Failed to load roster:", err);
        statusEl.textContent = "Failed to load roster. Please refresh or try again.";
        statusEl.className = "status error";
      }
    };
  </script>
</body>
</html>
